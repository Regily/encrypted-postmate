/*!
 * @overview encrypted-postmate - A powerful, simple, promise-based, encrypted postMessage library.
 * @copyright Copyright (c) 2017 Marat Dyatko
 * @license   Licensed under MIT license
 *            See https://opensource.org/licenses/MIT
 * @version   1.0.0
 */
!(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Postmate",[],t):"object"==typeof exports?exports.Postmate=t():e.Postmate=t()})(this,(function(){return (function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)})([(function(e,t,n){function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(){return++p}function o(){var e;v.debug&&(e=console).log.apply(e,arguments)}function s(e){var t=document.createElement("a");return t.href=e,t.origin||t.protocol+"//"+t.hostname}function a(e,t,n){return e.origin===t&&("object"===l(e.data)&&("postmate"in e.data&&(e.data.type===n&&("{"===e.data.postmate.substring(0,1)||!!{"handshake-reply":1,call:1,emit:1,reply:1,request:1}[e.data.postmate]))))}function u(e,t){var n="function"==typeof e[t]?e[t]():e[t];return f.resolve(n)}var c=(function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}})(),l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f="undefined"==typeof Promise?n(1).Promise:Promise,h="application/x-postmate-v1+json",d=Object.prototype.hasOwnProperty,p=0,m=(function(){function e(t){var n=this;r(this,e),this.parent=t.parent,this.frame=t.frame,this.child=t.child,this.childOrigin=t.childOrigin,this.messageType=t.messageType,this.getIncomingMessage=t.getIncomingMessage.bind(t),this.getOutcomingMessage=t.getOutcomingMessage.bind(t),this.events={},o("Parent: Registering API"),o("Parent: Awaiting messages..."),this.listener=function(e){var t=n.getIncomingMessage(e.data),r=t.value||{},i=r.data,s=r.name;"emit"===t.postmate&&(o("Parent: Received event emission: "+s),s in n.events&&n.events[s].call(n,i))},this.parent.addEventListener("message",this.listener,!1),o("Parent: Awaiting event emissions from Child")}return c(e,[{key:"get",value:function(e){var t=this;return new f(function(n){var r=i(),o=function e(i){var o=t.getIncomingMessage(i.data);o.uid===r&&"reply"===o.postmate&&(t.parent.removeEventListener("message",e,!1),n(o.value))};t.parent.addEventListener("message",o,!1),t.child.postMessage(t.getOutcomingMessage({postmate:"request",property:e,uid:r}),t.childOrigin)})}},{key:"call",value:function(e,t){this.child.postMessage(this.getOutcomingMessage({postmate:"call",property:e,data:t}),this.childOrigin)}},{key:"on",value:function(e,t){this.events[e]=t}},{key:"destroy",value:function(){o("Parent: Destroying Postmate instance"),window.removeEventListener("message",this.listener,!1),this.frame.parentNode.removeChild(this.frame)}}]),e})(),g=(function(){function e(t){var n=this;r(this,e),this.model=t.model,this.parent=t.parent,this.parentOrigin=t.parentOrigin,this.child=t.child,this.messageType=t.messageType,this.getIncomingMessage=t.getIncomingMessage.bind(t),this.getOutcomingMessage=t.getOutcomingMessage.bind(t),o("Child: Registering API"),o("Child: Awaiting messages..."),this.child.addEventListener("message",(function(e){if(a(e,n.parentOrigin,n.messageType)){var t=n.getIncomingMessage(e.data);o("Child: Received request",t);var r=t.property,i=t.uid,s=t.data;if("call"===t.postmate)return void(r in n.model&&"function"==typeof n.model[r]&&n.model[r].call(n,s));u(n.model,r).then((function(t){return e.source.postMessage(n.getOutcomingMessage({property:r,postmate:"reply",uid:i,value:t}),e.origin)}))}}))}return c(e,[{key:"emit",value:function(e,t){o('Child: Emitting Event "'+e+'"',t),this.parent.postMessage(this.getOutcomingMessage({postmate:"emit",value:{name:e,data:t}}),this.parentOrigin)}}]),e})(),v=(function(){function e(t){var n=t.container,i=t.url,o=t.model,s=t.messageType;return r(this,e),this.parent=window,this.frame=document.createElement("iframe"),(n||document.body).appendChild(this.frame),this.child=this.frame.contentWindow||this.frame.contentDocument.parentWindow,this.model=o||{},this.messageType=s||h,this.sendHandshake(i)}return c(e,[{key:"getIncomingMessage",value:function(e){return e}},{key:"getOutcomingMessage",value:function(e){return e.type=this.messageType,e}},{key:"sendHandshake",value:function(e){var t=this,n=s(e),r=this.messageType,i=0,u=void 0;return new f(function(s,c){var l=function e(i){return!!a(i,n,r)&&("handshake-reply"===t.getIncomingMessage(i.data).postmate?(clearInterval(u),o("Parent: Received handshake reply from Child"),t.parent.removeEventListener("message",e,!1),t.childOrigin=i.origin,o("Parent: Saving Child origin",t.childOrigin),t.handleHandshakeData(i.data),s(new m(t))):(o("Parent: Invalid handshake reply"),c("Failed handshake")))};t.parent.addEventListener("message",l,!1);var f=function(){i++,o("Parent: Sending handshake attempt "+i,{childOrigin:n}),t.child.postMessage(t.getHandshakeRequest(),n),5===i&&clearInterval(u)},h=function(){f(),u=setInterval(f,500)};t.frame.attachEvent?t.frame.attachEvent("onload",h):t.frame.onload=h,o("Parent: Loading frame",{url:e}),t.frame.src=e})}},{key:"getHandshakeRequest",value:function(){return this.getOutcomingMessage({postmate:"handshake",model:this.model})}},{key:"handleHandshakeData",value:function(e){}}]),e})();v.debug=!1,v.Model=(function(){function e(t,n){return r(this,e),this.child=window,this.model=t,this.parent=this.child.parent,this.messageType=n||h,this.sendHandshakeReply()}return c(e,[{key:"sendHandshakeReply",value:function(){var e=this;return new f(function(t,n){var r=function r(i){i.data.postmate&&("handshake"===i.data.postmate?(o("Child: Received handshake from Parent"),e.child.removeEventListener("message",r,!1),o("Child: Inherited and extended model from Parent"),e.handleHandshakeData(i.data),o("Child: Saving Parent origin",e.parentOrigin),e.parentOrigin=i.origin,o("Child: Sending handshake reply to Parent"),i.source.postMessage(e.getOutcomingMessage(e.getHandshakeResponse()),e.parentOrigin),t(new g(e))):n("Handshake Reply Failed"))};e.child.addEventListener("message",r,!1)})}},{key:"handleHandshakeData",value:function(e){var t=e.model;if(t)for(var n=Object.keys(t),r=0;r<n.length;r++)d.call(t,n[r])&&(this.model[n[r]]=t[n[r]])}},{key:"getHandshakeResponse",value:function(){return{postmate:"handshake-reply"}}},{key:"getIncomingMessage",value:function(e){return e}},{key:"getOutcomingMessage",value:function(e){return e.type=this.messageType,e}}]),e})(),e.exports=v}),(function(e,t,n){(function(t,r){/*!
 * @overview es6-promise - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
 * @version   4.1.1
 */
!(function(t,n){e.exports=n()})(0,(function(){"use strict";function e(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}function i(e){return"function"==typeof e}function o(e){z=e}function s(e){B=e}function a(){return void 0!==U?function(){U(c)}:u()}function u(){var e=setTimeout;return function(){return e(c,1)}}function c(){for(var e=0;e<K;e+=2){(0,Z[e])(Z[e+1]),Z[e]=void 0,Z[e+1]=void 0}K=0}function l(e,t){var n=arguments,r=this,i=new this.constructor(h);void 0===i[ee]&&S(i);var o=r._state;return o?(function(){var e=n[o-1];B((function(){return A(o,i,e,r._result)}))})():M(r,i,e,t),i}function f(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(h);return b(n,e),n}function h(){}function d(){return new TypeError("You cannot resolve a promise with itself")}function p(){return new TypeError("A promises callback cannot return that same promise.")}function m(e){try{return e.then}catch(e){return ie.error=e,ie}}function g(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}function v(e,t,n){B((function(e){var r=!1,i=g(n,t,(function(n){r||(r=!0,t!==n?b(e,n):k(e,n))}),(function(t){r||(r=!0,O(e,t))}),"Settle: "+(e._label||" unknown promise"));!r&&i&&(r=!0,O(e,i))}),e)}function y(e,t){t._state===ne?k(e,t._result):t._state===re?O(e,t._result):M(t,void 0,(function(t){return b(e,t)}),(function(t){return O(e,t)}))}function w(e,t,n){t.constructor===e.constructor&&n===l&&t.constructor.resolve===f?y(e,t):n===ie?(O(e,ie.error),ie.error=null):void 0===n?k(e,t):i(n)?v(e,t,n):k(e,t)}function b(t,n){t===n?O(t,d()):e(n)?w(t,n,m(n)):k(t,n)}function _(e){e._onerror&&e._onerror(e._result),T(e)}function k(e,t){e._state===te&&(e._result=t,e._state=ne,0!==e._subscribers.length&&B(T,e))}function O(e,t){e._state===te&&(e._state=re,e._result=t,B(_,e))}function M(e,t,n,r){var i=e._subscribers,o=i.length;e._onerror=null,i[o]=t,i[o+ne]=n,i[o+re]=r,0===o&&e._state&&B(T,e)}function T(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r=void 0,i=void 0,o=e._result,s=0;s<t.length;s+=3)r=t[s],i=t[s+n],r?A(n,r,i,o):i(o);e._subscribers.length=0}}function P(){this.error=null}function E(e,t){try{return e(t)}catch(e){return oe.error=e,oe}}function A(e,t,n,r){var o=i(n),s=void 0,a=void 0,u=void 0,c=void 0;if(o){if(s=E(n,r),s===oe?(c=!0,a=s.error,s.error=null):u=!0,t===s)return void O(t,p())}else s=r,u=!0;t._state!==te||(o&&u?b(t,s):c?O(t,a):e===ne?k(t,s):e===re&&O(t,s))}function j(e,t){try{t((function(t){b(e,t)}),(function(t){O(e,t)}))}catch(t){O(e,t)}}function C(){return se++}function S(e){e[ee]=se++,e._state=void 0,e._result=void 0,e._subscribers=[]}function x(e,t){this._instanceConstructor=e,this.promise=new e(h),this.promise[ee]||S(this.promise),N(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?k(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&k(this.promise,this._result))):O(this.promise,I())}function I(){return new Error("Array Methods must be provided an Array")}function L(e){return new x(this,e).promise}function H(e){var t=this;return new t(N(e)?function(n,r){for(var i=e.length,o=0;o<i;o++)t.resolve(e[o]).then(n,r)}:function(e,t){return t(new TypeError("You must pass an array to race."))})}function R(e){var t=this,n=new t(h);return O(n,e),n}function D(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function q(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function F(e){this[ee]=C(),this._result=this._state=void 0,this._subscribers=[],h!==e&&("function"!=typeof e&&D(),this instanceof F?j(this,e):q())}function W(){var e=void 0;if(void 0!==r)e=r;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=F}var Y=void 0;Y=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var N=Y,K=0,U=void 0,z=void 0,B=function(e,t){Z[K]=e,Z[K+1]=t,2===(K+=2)&&(z?z(c):$())},G="undefined"!=typeof window?window:void 0,J=G||{},Q=J.MutationObserver||J.WebKitMutationObserver,V="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),X="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Z=new Array(1e3),$=void 0;$=V?(function(){return function(){return t.nextTick(c)}})():Q?(function(){var e=0,t=new Q(c),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}})():X?(function(){var e=new MessageChannel;return e.port1.onmessage=c,function(){return e.port2.postMessage(0)}})():void 0===G?(function(){try{var e=n(4);return U=e.runOnLoop||e.runOnContext,a()}catch(e){return u()}})():u();var ee=Math.random().toString(36).substring(16),te=void 0,ne=1,re=2,ie=new P,oe=new P,se=0;return x.prototype._enumerate=function(e){for(var t=0;this._state===te&&t<e.length;t++)this._eachEntry(e[t],t)},x.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===f){var i=m(e);if(i===l&&e._state!==te)this._settledAt(e._state,t,e._result);else if("function"!=typeof i)this._remaining--,this._result[t]=e;else if(n===F){var o=new n(h);w(o,e,i),this._willSettleAt(o,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},x.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===te&&(this._remaining--,e===re?O(r,n):this._result[t]=n),0===this._remaining&&k(r,this._result)},x.prototype._willSettleAt=function(e,t){var n=this;M(e,void 0,(function(e){return n._settledAt(ne,t,e)}),(function(e){return n._settledAt(re,t,e)}))},F.all=L,F.race=H,F.resolve=f,F.reject=R,F._setScheduler=o,F._setAsap=s,F._asap=B,F.prototype={constructor:F,then:l,catch:function(e){return this.then(null,e)}},F.polyfill=W,F.Promise=F,F}))}).call(t,n(2),n(3))}),(function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function i(e){if(l===setTimeout)return setTimeout(e,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function o(e){if(f===clearTimeout)return clearTimeout(e);if((f===r||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{return f(e)}catch(t){try{return f.call(null,e)}catch(t){return f.call(this,e)}}}function s(){m&&d&&(m=!1,d.length?p=d.concat(p):g=-1,p.length&&a())}function a(){if(!m){var e=i(s);m=!0;for(var t=p.length;t;){for(d=p,p=[];++g<t;)d&&d[g].run();g=-1,t=p.length}d=null,m=!1,o(e)}}function u(e,t){this.fun=e,this.array=t}function c(){}var l,f,h=e.exports={};!(function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(e){l=n}try{f="function"==typeof clearTimeout?clearTimeout:r}catch(e){f=r}})();var d,p=[],m=!1,g=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];p.push(new u(e,t)),1!==p.length||m||i(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=c,h.addListener=c,h.once=c,h.off=c,h.removeListener=c,h.removeAllListeners=c,h.emit=c,h.prependListener=c,h.prependOnceListener=c,h.listeners=function(e){return[]},h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}}),(function(e,t){var n;n=(function(){return this})();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n}),(function(e,t){})])}));